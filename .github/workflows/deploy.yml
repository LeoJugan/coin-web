name: Deploy

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install browser dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libgstreamer1.0-0 \
          libgstreamer-plugins-base1.0-0 \
          libgstreamer-plugins-good1.0-0 \
          libgstreamer-plugins-bad1.0-0 \
          libgstreamer-plugins-ugly1.0-0 \
          libgtk-3-0 \
          libxss1 \
          libasound2-dev \
          libcups2 \
          libdrm2 \
          libxrandr2 \
          libgbm1 \
          libxcomposite1 \
          libxdamage1 \
          libxfixes3 \
          libxinerama1 \
          libxext6 \
          libgl1-mesa-dev \
          libglu1-mesa-dev \
          libgles2-mesa-dev \
          libsm6 \
          libice6 \
          libx264-dev \
          libnss3 \
          libatk1.0-0 \
          libatk-bridge2.0-0 \
          libxkbcommon0 \
          libxtst6 \
          libxshmfence1
      
    - name: Install Playwright dependencies
      run: npx playwright install-deps
      
    - name: Run tests
      run: npm run test:ci
      
    - name: Build application
      run: npm run build
      
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dist-${{ github.sha }}
        path: dist/
        retention-days: 30
        
    # 部署到 GitHub Pages
    - name: Deploy to GitHub Pages
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./dist
        cname: # 如果有自定義域名，在這裡填入
        
    # 如果您使用其他部署平台，可以取消註解並修改
    # - name: Deploy to Vercel
    #   uses: amondnet/vercel-action@v25
    #   with:
    #     vercel-token: ${{ secrets.VERCEL_TOKEN }}
    #     vercel-org-id: ${{ secrets.ORG_ID }}
    #     vercel-project-id: ${{ secrets.PROJECT_ID }}
    #     working-directory: ./
